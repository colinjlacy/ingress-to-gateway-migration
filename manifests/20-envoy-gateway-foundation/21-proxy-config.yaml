apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: nlb-proxy-config
  namespace: demo-gw-migration
spec:
  provider:
    type: Kubernetes
    kubernetes:
      envoyService:
        type: LoadBalancer
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
          service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
          service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:us-east-2:391633600189:certificate/62c55457-4166-492d-81c7-ff41df21e000"
          service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
          service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
          service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
          service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags: "Project=gateway-migration-demo,Controller=envoy-gateway,Environment=demo"
      envoyDeployment:
        replicas: 2
        pod: {}
          # OPTIONAL: Resource requests and limits
          # resources:
          #   requests:
          #     cpu: 100m
          #     memory: 128Mi
          #   limits:
          #     cpu: 500m
          #     memory: 512Mi
          
          # OPTIONAL: Node selection
          # nodeSelector:
          #   workload-type: gateway
          
          # OPTIONAL: Tolerations for tainted nodes
          # tolerations:
          # - key: "gateway-nodes"
          #   operator: "Equal"
          #   value: "true"
          #   effect: "NoSchedule"
          
          # OPTIONAL: Pod anti-affinity for high availability
          # affinity:
          #   podAntiAffinity:
          #     preferredDuringSchedulingIgnoredDuringExecution:
          #     - weight: 100
          #       podAffinityTerm:
          #         labelSelector:
          #           matchLabels:
          #             gateway.envoyproxy.io/owning-gateway-name: demo-gateway
          #         topologyKey: kubernetes.io/hostname

---
# Integration Notes:
# 
# This EnvoyProxy resource must be referenced by the Gateway resource's
# infrastructure configuration. See demo/40-gateway.yaml for the reference.
#
# Key AWS Integration Points:
# 1. ACM Certificate: Replace PLACEHOLDER_ACM_CERT_ARN with your certificate ARN
# 2. Subnets: Optionally specify which subnets to use for the NLB
# 3. Security Groups: Optionally specify security groups for the NLB
# 4. Health Checks: Customize health check behavior for your workload
# 5. Access Logs: Enable for debugging and compliance (requires S3 bucket)
#
# Troubleshooting:
# - If NLB doesn't provision, check CloudFormation events in AWS Console
# - Verify IAM permissions allow ELBv2 operations
# - Check that subnets have appropriate tags (kubernetes.io/role/elb=1)
# - Ensure security groups allow required traffic
