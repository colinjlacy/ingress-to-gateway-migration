---
# TCP Routing for MySQL Database
# This demonstrates Layer 4 (TCP) routing through the Gateway API
#
# Key Differences from Ingress-NGINX:
# - Ingress-NGINX: TCP services via ConfigMap (tcp: {"3306": "namespace/service:port"})
# - Gateway API: Native TCPRoute resource (cleaner, more consistent)
#
# Note: TCPRoute is less common in production. Most databases should use:
# 1. Internal ClusterIP services (no external access)
# 2. AWS RDS or managed databases
# 3. VPN/bastion host for admin access
#
# This demo shows TCP routing for educational purposes only!

apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
  name: mysql-tcp-route
  namespace: demo-gw-migration
  labels:
    demo: gateway-migration
    protocol: tcp
    service: mysql
spec:
  parentRefs:
  - name: demo-gateway
    sectionName: mysql
  
  rules:
  - backendRefs:
    - name: catalogue-db
      port: 3306

---
# Gateway Listener for MySQL TCP Traffic
# This needs to be added to the main Gateway resource (40-gateway.yaml)
# Shown here for documentation/reference
#
# apiVersion: gateway.networking.k8s.io/v1
# kind: Gateway
# metadata:
#   name: demo-gateway
# spec:
#   listeners:
#   # ... existing HTTP listeners ...
#   
#   # MySQL TCP listener
#   - name: mysql
#     protocol: TCP
#     port: 3306
#     allowedRoutes:
#       kinds:
#       - kind: TCPRoute

---
# Comparison Notes:
#
# INGRESS-NGINX APPROACH:
#   Helm values.yaml:
#     tcp:
#       3306: "demo-gw-migration/catalogue-db:3306"
#   
#   Pros: Simple configuration
#   Cons: 
#     - Not a Kubernetes resource (harder to manage)
#     - Requires Helm upgrade to change
#     - Port-based only (no host-based routing)
#
# GATEWAY API APPROACH:
#   TCPRoute resource (this file):
#     - Native Kubernetes resource
#     - Can be updated independently
#     - Consistent with HTTPRoute patterns
#     - Better RBAC and GitOps support
#   
#   Pros: Consistent API, better management
#   Cons: Requires Gateway listener configuration
#
# SECURITY WARNING:
#   Exposing databases publicly is dangerous! In production:
#   - Use internal LoadBalancer scheme
#   - Configure security groups (IP whitelist)
#   - Use AWS RDS instead of self-hosted MySQL
#   - Require SSL/TLS for database connections
#   - Use AWS Secrets Manager for credentials
