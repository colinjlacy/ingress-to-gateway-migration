apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: details-route
  namespace: demo-gw-migration
  labels:
    demo: gateway-migration
    team: catalog-team
    service: details
  annotations:
    owner: catalog-team@example.com
    last-modified: "2026-01-28"
    notes: "Fast service, needs lower timeout than default"
spec:
  parentRefs:
  - name: demo-gateway
  
  hostnames:
  - "app.gateway.colinjcodesalot.com"
  
  rules:
  # Primary details endpoint
  - matches:
    - path:
        type: PathPrefix
        value: /details
    backendRefs:
    - name: details
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Demo-Edge
          value: envoy-gateway
        - name: X-Team
          value: catalog-team
        - name: X-Service-Owner
          value: catalog-team@example.com
  
  # Legacy API v1 endpoint (for backwards compatibility)
  # TODO: Deprecate after mobile app v2.0 is fully deployed
  - matches:
    - path:
        type: PathPrefix
        value: /api/v1/details
    backendRefs:
    - name: details
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Demo-Edge
          value: envoy-gateway
        - name: X-API-Version
          value: v1-legacy
        - name: X-Deprecation-Warning
          value: "This endpoint is deprecated. Use /details instead."
  
  # Health check endpoint (dedicated route for monitoring)
  - matches:
    - path:
        type: Exact
        value: /details/health
    backendRefs:
    - name: details
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Health-Check
          value: "true"
        - name: X-Service
          value: details

---
# Catalog team's timeout policy (15s - faster than global default)
# This shows how Gateway API allows per-route customization without
# affecting other services
#
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: BackendTrafficPolicy
# metadata:
#   name: details-policy
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: details-route
#   timeout:
#     http:
#       requestTimeout: 15s  # Faster than other services
#   rateLimit:
#     type: Local
#     local:
#       rules:
#       - limit:
#           requests: 200
#           unit: Second
