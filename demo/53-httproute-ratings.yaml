apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: ratings-route
  namespace: demo-gw-migration
  labels:
    demo: gateway-migration
    team: analytics-team
    service: ratings
  annotations:
    owner: analytics-team@example.com
    last-modified: "2026-01-28"
    notes: "Stateless service - no session affinity needed"
spec:
  parentRefs:
  - name: demo-gateway
  
  hostnames:
  - "app.gateway.colinjcodesalot.com"
  
  rules:
  # Primary ratings endpoint (v1)
  - matches:
    - path:
        type: PathPrefix
        value: /ratings
      queryParams:
      - type: Exact
        name: version
        value: "1"
    - path:
        type: Exact
        value: /ratings
    backendRefs:
    - name: ratings
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Demo-Edge
          value: envoy-gateway
        - name: X-Team
          value: analytics-team
        - name: X-API-Version
          value: v1
  
  # Ratings API v2 (new schema with improved performance)
  - matches:
    - path:
        type: PathPrefix
        value: /api/v2/ratings
    - path:
        type: PathPrefix
        value: /ratings
      queryParams:
      - type: Exact
        name: version
        value: "2"
    backendRefs:
    - name: ratings
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Demo-Edge
          value: envoy-gateway
        - name: X-API-Version
          value: v2
        - name: X-Schema-Version
          value: "2.0"
  
  # Ratings health endpoint
  - matches:
    - path:
        type: Exact
        value: /ratings/health
    backendRefs:
    - name: ratings
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Health-Check
          value: "true"
        - name: X-Service
          value: ratings
  
  # Webhook endpoint (receives events from external system)
  # Note: In Gateway API, we can apply IP filtering via SecurityPolicy
  - matches:
    - path:
        type: Exact
        value: /ratings/webhook
      method: POST
    backendRefs:
    - name: ratings
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Webhook
          value: "true"
        - name: X-External-Source
          value: partner-system

---
# Ratings team's policies
# Shows NO session affinity (unlike the Ingress where it was forced globally)
#
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: BackendTrafficPolicy
# metadata:
#   name: ratings-policy
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: ratings-route
#   timeout:
#     http:
#       requestTimeout: 30s  # Standard timeout - ratings is fast
#   loadBalancer:
#     type: Random  # No session affinity - this is stateless!
#   rateLimit:
#     type: Local
#     local:
#       rules:
#       - limit:
#           requests: 50
#           unit: Second
#
# Security policy for webhook endpoint (IP whitelist)
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: SecurityPolicy
# metadata:
#   name: ratings-webhook-security
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: ratings-route
#   authorization:
#     rules:
#     - action: Allow
#       from:
#       - source:
#           principals:
#           - "partner-system/*"
#   # IP allowlist (example - adjust for your partner IPs)
#   # ipAllowlist:
#   # - 203.0.113.0/24
#   # - 198.51.100.0/24
