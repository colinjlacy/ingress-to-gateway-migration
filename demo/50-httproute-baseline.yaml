apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: productpage-route
  namespace: demo-gw-migration
  labels:
    demo: gateway-migration
    team: product-team
    service: productpage
  annotations:
    owner: product-team@example.com
    last-modified: "2026-01-28"
spec:
  parentRefs:
  - name: demo-gateway
  
  hostnames:
  - "app.gateway.colinjcodesalot.com"
  
  rules:
  # Main productpage route
  - matches:
    - path:
        type: PathPrefix
        value: /productpage
    - path:
        type: PathPrefix
        value: /static
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: productpage
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Demo-Edge
          value: envoy-gateway
        - name: X-Team
          value: product-team
  
  # Health check endpoint
  - matches:
    - path:
        type: Exact
        value: /health
    backendRefs:
    - name: productpage
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Health-Check
          value: "true"
  
  # Metrics endpoint (separate from health)
  - matches:
    - path:
        type: Exact
        value: /metrics
    backendRefs:
    - name: productpage
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Metrics-Endpoint
          value: "true"

---
# NOTE: In Gateway API, we can apply timeout policies per-route using
# a BackendPolicy or similar extension. This avoids the global timeout
# compromise we had in the Ingress configuration.
#
# Example (Envoy Gateway extension):
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: BackendTrafficPolicy
# metadata:
#   name: productpage-timeouts
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: productpage-route
#   timeout:
#     http:
#       requestTimeout: 30s
