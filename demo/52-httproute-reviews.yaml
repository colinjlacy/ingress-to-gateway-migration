apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: reviews-route
  namespace: demo-gw-migration
  labels:
    demo: gateway-migration
    team: reviews-team
    service: reviews
  annotations:
    owner: reviews-team@example.com
    last-modified: "2026-01-28"
    notes: "High-traffic service with complex business logic"
spec:
  parentRefs:
  - name: demo-gateway
  
  hostnames:
  - "app.gateway.colinjcodesalot.com"
  
  rules:
  # Primary reviews endpoint
  - matches:
    - path:
        type: PathPrefix
        value: /reviews
    backendRefs:
    - name: reviews
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Demo-Edge
          value: envoy-gateway
        - name: X-Team
          value: reviews-team
        - name: X-Service-Version
          value: v1
  
  # Legacy API v1 endpoint (partner contract until 2027)
  # CRITICAL: Do not remove - contractual obligation
  - matches:
    - path:
        type: PathPrefix
        value: /api/v1/reviews
    backendRefs:
    - name: reviews
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Demo-Edge
          value: envoy-gateway
        - name: X-API-Version
          value: v1-legacy
        - name: X-Partner-API
          value: "true"
  
  # Reviews submission endpoint
  - matches:
    - path:
        type: Exact
        value: /reviews/submit
      method: POST
    backendRefs:
    - name: reviews
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Operation
          value: submit-review
        - name: X-Requires-Auth
          value: "true"

---
# Reviews beta route (v2 testing)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: reviews-beta-route
  namespace: demo-gw-migration
  labels:
    demo: gateway-migration
    team: reviews-team
    service: reviews-v2
    environment: beta
  annotations:
    owner: reviews-team@example.com
    created: "2025-12-20"
    expires: "2026-03-31"
    notes: "Temporary route for A/B testing v2. Remove after full migration."
spec:
  parentRefs:
  - name: demo-gateway
  
  hostnames:
  - "app.gateway.colinjcodesalot.com"
  
  rules:
  # Beta testing endpoint for reviews v2
  - matches:
    - path:
        type: PathPrefix
        value: /reviews/beta
    backendRefs:
    - name: reviews-v2
      port: 9080
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Demo-Edge
          value: envoy-gateway
        - name: X-Service-Version
          value: v2-beta
        - name: X-Beta-Feature
          value: "true"

---
# Reviews team's policies (longer timeout for complex operations)
# Shows how different teams can have different requirements without compromise
#
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: BackendTrafficPolicy
# metadata:
#   name: reviews-policy
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: reviews-route
#   timeout:
#     http:
#       requestTimeout: 60s  # Longer than default - reviews needs it
#   retry:
#     numRetries: 3
#     retryOn:
#       httpStatusCodes:
#       - 503
#   loadBalancer:
#     type: LeastRequest
#
# CORS policy for reviews (only this service needs it)
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: SecurityPolicy
# metadata:
#   name: reviews-cors
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: reviews-route
#   cors:
#     allowOrigins:
#     - "https://bookinfo-frontend.example.com"
#     - "https://partner-app.example.com"
#     allowMethods:
#     - GET
#     - POST
#     - PUT
#     - DELETE
#     allowCredentials: true
